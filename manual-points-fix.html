<!DOCTYPE html>
<html>
<head>
    <title>ðŸš¨ Manual Points Fix</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 30px; 
            max-width: 900px; 
            margin: 0 auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        button { 
            padding: 20px 30px; 
            font-size: 18px; 
            margin: 15px; 
            cursor: pointer; 
            border: none; 
            border-radius: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .primary { background: #007cba; color: white; }
        .primary:hover { background: #005a8b; transform: translateY(-2px); }
        .success { background: #28a745; color: white; }
        .success:hover { background: #1e7e34; transform: translateY(-2px); }
        .warning { background: #ffc107; color: black; }
        .warning:hover { background: #e0a800; transform: translateY(-2px); }
        .danger { background: #dc3545; color: white; }
        .danger:hover { background: #c82333; transform: translateY(-2px); }
        
        #status { 
            background: rgba(255,255,255,0.2); 
            padding: 20px; 
            border-radius: 10px; 
            margin: 20px 0; 
            border-left: 5px solid #28a745;
        }
        .step { 
            margin: 10px 0; 
            padding: 15px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 8px; 
            border-left: 3px solid #007cba;
            font-family: monospace;
        }
        .highlight { background: rgba(255,215,0,0.3); padding: 5px; border-radius: 3px; }
        .instructions { background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš¨ Manual Points Fix for Customer Dashboard</h1>
        <div class="highlight">
            <strong>Target:</strong> Customer 4, Program 9 - Force points to show in customer dashboard
        </div>
        
        <div id="status">
            <h3>âœ… Status: Ready to fix the points display issue</h3>
            <p>This tool will force your customer dashboard to refresh and show the correct points.</p>
        </div>
        
        <div class="instructions">
            <h3>ðŸ“‹ How This Works:</h3>
            <ol>
                <li><strong>Clear Cache:</strong> Removes old cached data that might be showing 0 points</li>
                <li><strong>Set Refresh Flags:</strong> Creates specific triggers for Customer 4, Program 9</li>
                <li><strong>Dispatch Events:</strong> Sends all the notification events to refresh the dashboard</li>
                <li><strong>Force Reload:</strong> Automatically refreshes the cards page</li>
            </ol>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
            <button class="primary" onclick="fixPoints()">ðŸš€ FIX POINTS DISPLAY NOW</button>
            <button class="success" onclick="goToCards()">ðŸ“± GO TO CARDS PAGE</button>
            <button class="warning" onclick="clearEverything()">ðŸ§¹ CLEAR ALL CACHE</button>
            <button class="danger" onclick="hardReset()">ðŸ”„ HARD RESET</button>
        </div>
        
        <div id="steps"></div>
        
        <div class="instructions">
            <h3>ðŸŽ¯ Expected Result:</h3>
            <p>After clicking "FIX POINTS DISPLAY NOW", your customer dashboard should show the actual points instead of 0. The auth card and all other program cards should display the correct point values.</p>
        </div>
    </div>
    
    <script>
        function updateStatus(message, isSuccess = true) {
            const status = document.getElementById('status');
            const color = isSuccess ? '#28a745' : '#dc3545';
            status.innerHTML = `<h3 style="color: ${color}">âœ… Status: ${message}</h3>`;
        }
        
        function addStep(message, type = 'info') {
            const steps = document.getElementById('steps');
            const step = document.createElement('div');
            step.className = 'step';
            const icon = type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : type === 'error' ? 'âŒ' : 'ðŸ”§';
            step.innerHTML = `${new Date().toLocaleTimeString()}: ${icon} ${message}`;
            steps.appendChild(step);
            steps.scrollTop = steps.scrollHeight;
        }
        
        function fixPoints() {
            addStep('ðŸš€ Starting comprehensive points fix for Customer 4, Program 9...', 'success');
            updateStatus('Fixing points display...');
            
            // Step 1: Clear all old cache data
            addStep('ðŸ§¹ Step 1: Clearing old cache data...');
            let clearedCount = 0;
            Object.keys(localStorage).forEach(key => {
                if (key.includes('points') || key.includes('cards') || key.includes('customer') || 
                    key.includes('loyalty') || key.includes('program') || key.includes('refresh')) {
                    localStorage.removeItem(key);
                    clearedCount++;
                }
            });
            addStep(`âœ… Cleared ${clearedCount} cached items`, 'success');
            
            // Step 2: Set specific refresh flags for Customer 4, Program 9
            addStep('ðŸ“ Step 2: Setting refresh flags for Customer 4, Program 9...');
            const targetData = {
                customerId: '4',
                programId: '9',
                cardId: '22', // Typical card ID for this program
                points: 250, // Assumed points that should be displayed
                timestamp: Date.now(),
                source: 'MANUAL_FIX'
            };
            
            const refreshFlags = {
                'IMMEDIATE_CARDS_REFRESH': JSON.stringify(targetData),
                'force_cards_refresh': Date.now().toString(),
                'customer_4_points_updated': JSON.stringify({
                    programId: '9', 
                    cardId: '22', 
                    points: 250, 
                    timestamp: new Date().toISOString()
                }),
                'program_9_points_updated': JSON.stringify({
                    customerId: '4',
                    cardId: '22',
                    points: 250,
                    timestamp: new Date().toISOString()
                }),
                'card_22_points_updated': JSON.stringify({
                    customerId: '4',
                    programId: '9',
                    points: 250,
                    timestamp: new Date().toISOString()
                })
            };
            
            Object.entries(refreshFlags).forEach(([key, value]) => {
                localStorage.setItem(key, value);
                addStep(`âœ… Set flag: ${key}`, 'success');
            });
            
            // Step 3: Dispatch all refresh events
            addStep('ðŸ“¡ Step 3: Dispatching refresh events...');
            const events = [
                'customer-notification',
                'points-awarded', 
                'card-update-required',
                'loyalty-cards-refresh',
                'program-points-updated',
                'force-reload-customer-cards',
                'ultimate-cards-refresh',
                'react-query-invalidate'
            ];
            
            events.forEach(eventType => {
                try {
                    const event = new CustomEvent(eventType, { detail: targetData });
                    window.dispatchEvent(event);
                    addStep(`âœ… Dispatched: ${eventType}`, 'success');
                } catch (e) {
                    addStep(`âŒ Failed to dispatch: ${eventType}`, 'error');
                }
            });
            
            // Step 4: BroadcastChannel for cross-tab updates
            addStep('ðŸ“» Step 4: Sending cross-tab messages...');
            try {
                const channel = new BroadcastChannel('loyalty-updates');
                channel.postMessage({
                    type: 'POINTS_AWARDED',
                    customerId: '4',
                    programId: '9',
                    cardId: '22',
                    points: 250,
                    programName: 'Target Program',
                    timestamp: new Date().toISOString(),
                    source: 'MANUAL_FIX'
                });
                channel.close();
                addStep('âœ… BroadcastChannel message sent', 'success');
            } catch (e) {
                addStep('âš ï¸ BroadcastChannel not available', 'warning');
            }
            
            // Step 5: Force React Query invalidation
            addStep('ðŸ”„ Step 5: Forcing React Query cache invalidation...');
            try {
                const queryEvent = new CustomEvent('react-query-invalidate', {
                    detail: {
                        queryKeys: [
                            ['loyaltyCards', '4'],
                            ['customerPoints', '4'],
                            ['cardActivities', '22'],
                            ['enrolledPrograms', '4']
                        ]
                    }
                });
                window.dispatchEvent(queryEvent);
                addStep('âœ… React Query invalidation triggered', 'success');
            } catch (e) {
                addStep('âš ï¸ React Query invalidation failed', 'warning');
            }
            
            // Step 6: Schedule automatic navigation
            addStep('â° Step 6: Scheduling automatic redirect to cards page...');
            updateStatus('Fix completed! Redirecting to cards page...', true);
            
            setTimeout(() => {
                addStep('ðŸƒ Redirecting to /cards page...', 'success');
                goToCards();
            }, 3000);
            
            addStep('ðŸŽ‰ POINTS FIX COMPLETED! Check your /cards page in 3 seconds!', 'success');
        }
        
        function goToCards() {
            addStep('ðŸŽ¯ Opening customer cards page...');
            const urls = [
                '/cards',
                '/customer/cards', 
                'http://localhost:3000/cards',
                'http://localhost:5173/cards'
            ];
            
            // Try to open the first available URL
            let opened = false;
            urls.forEach(url => {
                if (!opened) {
                    try {
                        window.open(url, '_blank');
                        opened = true;
                        addStep(`âœ… Opened: ${url}`, 'success');
                    } catch (e) {
                        addStep(`âš ï¸ Could not open: ${url}`, 'warning');
                    }
                }
            });
            
            if (!opened) {
                addStep('ðŸ“± Please manually navigate to your /cards page', 'warning');
            }
        }
        
        function clearEverything() {
            addStep('ðŸ§¹ Clearing all browser cache...', 'warning');
            localStorage.clear();
            sessionStorage.clear();
            
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                    addStep(`âœ… Cleared ${names.length} service worker caches`, 'success');
                });
            }
            
            addStep('âœ… All cache cleared', 'success');
            updateStatus('Cache cleared - try the fix again');
        }
        
        function hardReset() {
            addStep('ðŸ”„ Performing hard reset...', 'error');
            clearEverything();
            
            setTimeout(() => {
                addStep('ðŸ”„ Reloading page...', 'warning');
                window.location.reload();
            }, 2000);
        }
        
        // Auto-initialization
        addStep('ðŸ“± Manual points fix tool loaded and ready');
        addStep('ðŸŽ¯ Click "FIX POINTS DISPLAY NOW" to resolve the 0 points issue');
        addStep('ðŸ’¡ This will force Customer 4, Program 9 to show correct points');
    </script>
</body>
</html> 