<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- CRITICAL BROWSER POLYFILL: Must be first script to execute -->
    <script>
      // Immediate critical polyfills for browser extension APIs
      (function() {
        console.log('Applying critical browser polyfills');

        // Specifically shim module pattern functions from error logs
        window['3'] = function() { return {}; };
        window['1230'] = function() { return {}; };
        window['i'] = function() { return {}; };
        window['n'] = function() { return {}; };
        
        // Create browser objects
        window.browser = {
          runtime: {
            sendMessage: function() { return Promise.resolve(); },
            onMessage: { addListener: function() {}, removeListener: function() {} },
            getURL: function(path) { return path; },
            connect: function() {
              return {
                postMessage: function() {},
                onMessage: { addListener: function() {} },
                onDisconnect: { addListener: function() {} }
              };
            },
            lastError: null
          },
          tabs: { 
            query: function() { return Promise.resolve([]); },
            sendMessage: function() { return Promise.resolve(); }
          },
          storage: { 
            local: { get: function() { return Promise.resolve({}); }, set: function() { return Promise.resolve(); } },
            sync: { get: function() { return Promise.resolve({}); }, set: function() { return Promise.resolve(); } }
          }
        };
        
        // Chrome compatibility
        window.chrome = window.chrome || {
          runtime: window.browser.runtime,
          storage: window.browser.storage,
          tabs: window.browser.tabs,
          extension: { getURL: function(path) { return path; } }
        };
        
        // Error handling
        window.addEventListener('error', function(event) {
          if (event && event.error && event.error.message && 
              (event.error.message.includes('browser is not defined') || 
               event.error.message.includes('chrome is not defined'))) {
            console.warn('Critical polyfill: Suppressed error:', event.error.message);
            event.preventDefault();
            event.stopPropagation();
            return false;
          }
        }, true);
        
        // Content script error suppression
        const originalConsoleError = console.error;
        console.error = function(...args) {
          // If the error contains browser is not defined, suppress it
          if (args[0] && typeof args[0] === 'string' && 
              (args[0].includes('browser is not defined') || 
               args[0].includes('ReferenceError: browser') ||
               args[0].includes("Cannot use 'in' operator"))) {
            console.warn('Suppressed error:', args[0].substring(0, 50) + '...');
            return;
          }
          return originalConsoleError.apply(console, args);
        };
        
        // Patch for "Cannot use 'in' operator" error
        const originalArrayMap = Array.prototype.map;
        Array.prototype.map = function(callback) {
          if (this === null || this === undefined) {
            throw new TypeError('Array.prototype.map called on null or undefined');
          }
          
          try {
            return originalArrayMap.apply(this, arguments);
          } catch (error) {
            if (error && error.message && error.message.includes("Cannot use 'in' operator")) {
              console.warn('Caught "in" operator error in Array.map, returning safe result');
              // Return a safe result instead of throwing
              return [];
            }
            throw error;
          }
        };
        
        window.__BROWSER_POLYFILL_LOADED__ = true;
        
        console.log('Critical browser polyfill applied');
      })();
    </script>

    <!-- Direct patch for problematic content scripts -->
    <script src="/content-script-patch.js"></script>

    <!-- Special fix for content scripts -->
    <script src="/fix-content-scripts.js"></script>

    <!-- Load browser polyfill first for extension compatibility -->
    <script src="/fix-browser-global.js"></script>

    <!-- LODASH FIX -->
    <script>
      // Lodash preinitialization
      var _ = window._ = {
        noop: function() {},
        identity: function(value) { return value; },
        isObject: function(obj) { return obj !== null && typeof obj === 'object'; },
        isFunction: function(f) { return typeof f === 'function'; },
        isArray: Array.isArray,
        forEach: function(collection, iteratee) {
          if (Array.isArray(collection)) {
            for (let i = 0; i < collection.length; i++) iteratee(collection[i], i, collection);
          } else if (collection && typeof collection === 'object') {
            for (let key in collection) {
              if (Object.prototype.hasOwnProperty.call(collection, key)) {
                iteratee(collection[key], key, collection);
              }
            }
          }
          return collection;
        },
        map: function(collection, iteratee) {
          const result = [];
          if (Array.isArray(collection)) {
            for (let i = 0; i < collection.length; i++) result.push(iteratee(collection[i], i, collection));
          } else if (collection && typeof collection === 'object') {
            for (let key in collection) {
              if (Object.prototype.hasOwnProperty.call(collection, key)) {
                result.push(iteratee(collection[key], key, collection));
              }
            }
          }
          return result;
        }
      };
      
      console.log('Emergency lodash fix applied');
    </script>
    
    <!-- Load polyfill loader for additional polyfills -->
    <script src="/polyfill-loader.js"></script>
    
    <!-- Full browser polyfill -->
    <script src="/browser-polyfill.js"></script>
    
    <!-- Standard head tags -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="gudcity 12 Loyalty Platform - Premium QR code-based loyalty program management">
    <meta name="theme-color" content="#3b82f6">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/assets/icon-192x192.png">
    <link rel="manifest" href="/manifest.json" crossorigin="use-credentials">
    <title>gudcity 12 Loyalty</title>
    
    <!-- PWA Manifest Fix -->
    <script>
      // We won't modify the manifest through JavaScript as it's causing issues
      // Instead, we've fixed the manifest.json file directly with proper relative paths
      console.log("Using direct manifest.json with corrected paths");
    </script>
    
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Fast page transitions -->
    <script>
      document.addEventListener('click', e => {
        const { target } = e;
        if (target.tagName === 'A' && target.href.startsWith(window.location.origin)) {
          const url = new URL(target.href);
          // Only prefetch same-origin navigations
          if (url.origin === window.location.origin) {
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = url.href;
            document.head.appendChild(link);
          }
        }
      });
    </script>
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://gudcity.io/">
  </head>
  <body>
    <!-- App Root -->
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- No-JS fallback -->
    <noscript>
      <div style="padding: 2rem; text-align: center; font-family: system-ui, sans-serif;">
        <h1>JavaScript Required</h1>
        <p>This application requires JavaScript to run. Please enable JavaScript in your browser settings.</p>
      </div>
    </noscript>
  </body>
</html>
