<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- CRITICAL FIXES FOR LODASH - MUST BE FIRST -->
    <script>
      // Emergency inline fix - define global _ immediately at the very top
      window._ = window._ || {
        noop: function() {},
        identity: function(value) { return value; }
      };
      console.log("Emergency inline lodash fix applied");
    </script>
    <script src="/lodash-preload.js"></script>
    <script src="/charts-lodash-fix.js"></script>
    
    <!-- Standard head tags -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Gudcity Loyalty Platform - QR code-based loyalty program management">
    <meta name="theme-color" content="#3b82f6">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/assets/icon-192x192.png">
    <link rel="manifest" href="/manifest.json">
    <title>Gudcity Loyalty</title>
    
    <!-- FIX 2: Generate Missing PWA Icons - This fixes the manifest icon error -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Fix for missing manifest icon
        const manifestLink = document.querySelector('link[rel="manifest"]');
        
        if (manifestLink) {
          fetch(manifestLink.href)
            .then(response => response.json())
            .catch(() => ({})) // If fetch fails, use empty object
            .then(manifest => {
              // Create a new manifest object
              const fixedManifest = manifest || {};
              
              // Ensure icons array exists and use favicon.ico as fallback
              if (!fixedManifest.icons || !Array.isArray(fixedManifest.icons) || fixedManifest.icons.length === 0) {
                fixedManifest.icons = [{
                  src: '/favicon.ico',
                  sizes: '192x192',
                  type: 'image/x-icon'
                }];
              } else {
                // Fix any icon paths that point to missing files
                fixedManifest.icons = fixedManifest.icons.map(icon => {
                  if (icon.src.includes('/assets/icon-192x192.png')) {
                    return {
                      ...icon,
                      src: '/favicon.ico'
                    };
                  }
                  return icon;
                });
              }
              
              // Create a blob with the fixed manifest
              const fixedManifestBlob = new Blob(
                [JSON.stringify(fixedManifest)],
                { type: 'application/json' }
              );
              
              // Create a URL for the blob
              const fixedManifestURL = URL.createObjectURL(fixedManifestBlob);
              
              // Replace the original manifest link
              manifestLink.href = fixedManifestURL;
              
              console.log("PWA manifest icons fixed");
            });
        }
      });
    </script>
    
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Preload critical assets -->
    <link rel="preload" href="/fonts/Inter-roman.var.woff2" as="font" type="font/woff2" crossorigin>
    
    <!-- Fast page transitions -->
    <script type="module">
      document.addEventListener('click', e => {
        const { target } = e;
        if (target.tagName === 'A' && target.href.startsWith(window.location.origin)) {
          const url = new URL(target.href);
          // Only prefetch same-origin navigations
          if (url.origin === window.location.origin) {
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = url.href;
            document.head.appendChild(link);
          }
        }
      });
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- No-JS fallback -->
    <noscript>
      <div style="padding: 2rem; text-align: center; font-family: system-ui, sans-serif;">
        <h1>JavaScript Required</h1>
        <p>This application requires JavaScript to run. Please enable JavaScript in your browser settings.</p>
      </div>
    </noscript>
  </body>
</html>
