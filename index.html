<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- AGGRESSIVE LODASH FIX -->
    <script>
      // CRITICAL: Lodash preinitialization before ANYTHING else
      // This variable MUST be defined before any script loads
      var _ = window._ = {
        noop: function() {},
        identity: function(value) { return value; },
        isObject: function(obj) { return obj !== null && typeof obj === 'object'; },
        isFunction: function(f) { return typeof f === 'function'; },
        isArray: Array.isArray,
        forEach: function(collection, iteratee) {
          if (Array.isArray(collection)) {
            for (let i = 0; i < collection.length; i++) iteratee(collection[i], i, collection);
          } else if (collection && typeof collection === 'object') {
            for (let key in collection) {
              if (Object.prototype.hasOwnProperty.call(collection, key)) {
                iteratee(collection[key], key, collection);
              }
            }
          }
          return collection;
        },
        map: function(collection, iteratee) {
          const result = [];
          if (Array.isArray(collection)) {
            for (let i = 0; i < collection.length; i++) result.push(iteratee(collection[i], i, collection));
          } else if (collection && typeof collection === 'object') {
            for (let key in collection) {
              if (Object.prototype.hasOwnProperty.call(collection, key)) {
                result.push(iteratee(collection[key], key, collection));
              }
            }
          }
          return result;
        }
      };
      
      // Browser polyfill to prevent "browser is not defined" errors
      window.browser = window.browser || {
        runtime: { 
          sendMessage: function(){}, 
          onMessage: { addListener: function(){}, removeListener: function(){} },
          getManifest: function() { return {}; },
          getURL: function(path) { return path; }
        },
        storage: { 
          local: { get: function(){}, set: function(){}, remove: function(){} },
          sync: { get: function(){}, set: function(){}, remove: function(){} }
        },
        tabs: {
          query: function(){}, 
          create: function(){}, 
          update: function(){}
        }
      };
      
      console.log('Emergency fixes applied directly in HTML');
    </script>
    
    <!-- Load polyfills -->
    <script src="/fix-browser-global.js" onerror="console.error('Failed to load fix-browser-global.js')"></script>
    <script src="/browser-polyfill.js" onerror="console.error('Failed to load browser-polyfill.js')"></script>
    <script src="/lodash-preload.js" onerror="console.error('Failed to load lodash-preload.js')"></script>
    <script src="/charts-lodash-fix.js" onerror="console.error('Failed to load charts-lodash-fix.js')"></script>
    
    <!-- Standard head tags -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Gudcity Loyalty Platform - QR code-based loyalty program management">
    <meta name="theme-color" content="#3b82f6">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/assets/icon-192x192.png">
    <link rel="manifest" href="/manifest.json" crossorigin="use-credentials">
    <title>Gudcity Loyalty</title>
    
    <!-- PWA Manifest Fix -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Fix for missing manifest icon and path issues
        const manifestLink = document.querySelector('link[rel="manifest"]');
        
        if (manifestLink) {
          fetch(manifestLink.href)
            .then(response => response.json())
            .catch(() => ({}))
            .then(manifest => {
              // Create a fixed manifest object
              const fixedManifest = manifest || {};
              
              // Fix icon paths
              if (fixedManifest.icons && Array.isArray(fixedManifest.icons)) {
                fixedManifest.icons = fixedManifest.icons.map(icon => {
                  return {
                    ...icon,
                    src: (icon.src.startsWith('/') ? '' : '/') + icon.src.replace(/^\/+/, '')
                  };
                });
              }
              
              // Fix start_url
              if (fixedManifest.start_url) {
                fixedManifest.start_url = (fixedManifest.start_url.startsWith('/') ? '' : '/') + 
                  fixedManifest.start_url.replace(/^\/+/, '');
              }
              
              // Fix shortcuts
              if (fixedManifest.shortcuts && Array.isArray(fixedManifest.shortcuts)) {
                fixedManifest.shortcuts = fixedManifest.shortcuts.map(shortcut => {
                  return {
                    ...shortcut,
                    url: shortcut.url ? 
                      (shortcut.url.startsWith('/') ? '' : '/') + shortcut.url.replace(/^\/+/, '') : '/'
                  };
                });
              }
              
              // Create a blob with the fixed manifest
              const fixedManifestBlob = new Blob(
                [JSON.stringify(fixedManifest, null, 2)],
                { type: 'application/json' }
              );
              
              // Create a URL for the blob
              const fixedManifestURL = URL.createObjectURL(fixedManifestBlob);
              
              // Replace the original manifest link
              manifestLink.href = fixedManifestURL;
              
              console.log("PWA manifest fixed with absolute paths");
            });
        }
      });
    </script>
    
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Preload critical assets -->
    <link rel="preload" href="/fonts/Inter-roman.var.woff2" as="font" type="font/woff2" crossorigin>
    
    <!-- Fast page transitions -->
    <script type="module">
      document.addEventListener('click', e => {
        const { target } = e;
        if (target.tagName === 'A' && target.href.startsWith(window.location.origin)) {
          const url = new URL(target.href);
          // Only prefetch same-origin navigations
          if (url.origin === window.location.origin) {
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = url.href;
            document.head.appendChild(link);
          }
        }
      });
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- No-JS fallback -->
    <noscript>
      <div style="padding: 2rem; text-align: center; font-family: system-ui, sans-serif;">
        <h1>JavaScript Required</h1>
        <p>This application requires JavaScript to run. Please enable JavaScript in your browser settings.</p>
      </div>
    </noscript>
  </body>
</html>
